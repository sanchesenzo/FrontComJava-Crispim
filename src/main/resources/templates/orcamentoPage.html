<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | Orçamentos</title>

  <style>
    /* 1. Importação da Fonte e Variáveis */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    :root {
      --cor-fundo-light: #f4f7fa; /* Fundo principal */
      --cor-fundo-dark: #1f2937;  /* Fundo da sidebar */
      --cor-fundo-dark-hover: #374151;
      --cor-superficie: #ffffff;  /* Card, Modal */
      --cor-primaria: #6366f1;   /* Roxo/Índigo */
      --cor-primaria-hover: #4f46e5;
      --cor-texto-light: #f9fafb; /* Texto na sidebar */
      --cor-texto-dark: #374151;  /* Texto principal */
      --cor-texto-secundario: #6b7280;
      --cor-borda: #e5e7eb;
      --cor-perigo: #ef4444;
      --cor-perigo-hover: #dc2626;
      --sombra: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    /* 2. Reset e Globais */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background-color: var(--cor-fundo-light);
      color: var(--cor-texto-dark);
      line-height: 1.5;
      overflow: hidden; /* Começa travado pelo layout */
    }
    button, input, select {
      font-family: inherit;
    }

    /* 3. Layout Principal (Sidebar + Main) */
    .layout-container {
      display: grid;
      grid-template-columns: 260px 1fr;
      height: 100vh;
    }

    /* 4. Sidebar (Navegação) */
    .sidebar {
      background-color: var(--cor-fundo-dark);
      color: var(--cor-texto-light);
      padding: 2rem;
      display: flex;
      flex-direction: column;
      gap: 2.5rem;
    }
    .sidebar-logo {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--cor-superficie);
      text-align: center;
      text-decoration: none;
    }
    .sidebar-nav {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .sidebar-nav a {
      color: var(--cor-texto-secundario);
      text-decoration: none;
      font-weight: 500;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transition: background-color 0.2s ease, color 0.2s ease;
    }
    .sidebar-nav svg {
      width: 20px;
      height: 20px;
    }
    .sidebar-nav a:hover {
      background-color: var(--cor-fundo-dark-hover);
      color: var(--cor-texto-light);
    }
    .sidebar-nav a.active {
      background-color: var(--cor-primaria);
      color: var(--cor-texto-light);
      font-weight: 600;
    }

    /* 5. Conteúdo Principal */
    .main-content {
      padding: 2.5rem 3rem;
      overflow-y: auto; /* Scroll só no conteúdo */
    }
    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    .main-title {
      font-size: 2rem;
      font-weight: 700;
    }
    
    /* 6. Tabela */
    .table-container {
      background-color: var(--cor-superficie);
      border-radius: 12px;
      box-shadow: var(--sombra);
      overflow: hidden;
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0; 
    }
    thead th {
      background-color: var(--cor-fundo-light);
      padding: 1rem 1.5rem;
      text-align: left;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--cor-texto-secundario);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    tbody tr:hover {
      background-color: #fcfcff;
    }
    tbody td {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--cor-borda);
      font-weight: 500;
    }
    tbody tr:last-child td {
      border-bottom: none;
    }
    .table-actions {
      display: flex;
      gap: 0.75rem;
    }
    .valor-cell {
      font-weight: 600;
      color: var(--cor-primaria);
    }

    /* 7. Botões */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.65rem 1.25rem;
      font-size: 0.9rem;
      border-radius: 8px;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
      font-weight: 600;
    }
    .btn svg {
      width: 16px;
      height: 16px;
    }
    .btn-primary { 
      background-color: var(--cor-primaria); 
      color: #ffffff; 
      box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.4);
    }
    .btn-primary:hover { 
      background-color: var(--cor-primaria-hover); 
      transform: translateY(-2px);
    }
    .btn-secondary {
      background-color: var(--cor-superficie);
      color: var(--cor-texto-dark);
      border: 1px solid var(--cor-borda);
    }
    .btn-secondary:hover { background-color: var(--cor-fundo-light); }
    .btn-icon {
      padding: 0.6rem;
      border-radius: 6px;
    }
    .btn-danger { 
      background-color: var(--cor-perigo); 
      color: #ffffff; 
    }
    .btn-danger:hover { background-color: var(--cor-perigo-hover); }
    
    /* 8. Modal Multi-Etapas (Wizard) */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background-color: rgba(31, 41, 55, 0.5);
      backdrop-filter: blur(4px);
      display: grid;
      place-items: center;
      visibility: hidden;
      opacity: 0;
      transition: visibility 0.2s ease, opacity 0.2s ease;
    }
    .modal-backdrop.active {
      visibility: visible;
      opacity: 1;
    }
    .modal {
      background-color: var(--cor-superficie);
      border-radius: 12px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 600px;
      transform: scale(0.95);
      transition: transform 0.2s ease;
      overflow: hidden; /* Para conter os elementos internos */
    }
    .modal-backdrop.active .modal {
      transform: scale(1);
    }
    .modal-header {
      padding: 1.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--cor-borda);
    }
    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
    }
    .modal-step-indicator {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--cor-texto-secundario);
    }
    .modal-close-btn {
      background: none; border: none; cursor: pointer; color: var(--cor-texto-secundario);
    }
    .modal-close-btn svg { width: 24px; height: 24px; }
    
    .modal-body {
      padding: 2rem;
    }
    /* Controla a visibilidade da etapa */
    .modal-step {
      display: none;
    }
    .modal-step.active {
      display: block;
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      font-size: 0.9rem;
      color: var(--cor-texto-dark);
    }
    input, select {
      width: 100%;
      padding: 0.75rem 1rem;
      background-color: var(--cor-fundo-light);
      border: 1px solid var(--cor-borda);
      border-radius: 8px;
      color: var(--cor-texto-dark);
      font-size: 1rem;
    }
    input:focus, select:focus {
      outline: none;
      border-color: var(--cor-primaria);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }
    .modal-footer {
      padding: 1.5rem 2rem;
      background-color: var(--cor-fundo-light);
      border-top: 1px solid var(--cor-borda);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* 9. Componentes de Pesquisa no Modal */
    .search-results-modal {
      background-color: var(--cor-fundo-light);
      border: 1px solid var(--cor-borda);
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 0.5rem;
    }
    .result-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background-color 0.2s ease;
    }
    .result-item:hover {
      background-color: #e9ecef;
    }
    .result-item:not(:last-child) {
      border-bottom: 1px solid var(--cor-borda);
    }
    .selected-item-info {
      background-color: var(--cor-fundo-light);
      padding: 0.75rem 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      font-weight: 500;
      color: var(--cor-primaria);
      border: 1px solid var(--cor-primaria);
    }
    .selected-item-info strong {
      color: var(--cor-texto-dark);
    }

    /* 10. Resumo no Passo 3 */
    .summary-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .summary-box {
      background-color: var(--cor-fundo-light);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid var(--cor-borda);
    }
    .summary-box label {
      font-size: 0.8rem;
      color: var(--cor-texto-secundario);
      margin-bottom: 0.25rem;
    }
    .summary-box p {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--cor-texto-dark);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* 11. Responsividade */
    @media (max-width: 768px) {
      .layout-container {
        grid-template-columns: 1fr;
      }
      .sidebar {
        display: none; /* Esconder sidebar */
      }
      .main-content {
        padding: 1.5rem;
      }
      .modal {
        max-width: 90vw;
      }
      .summary-grid {
        grid-template-columns: 1fr; /* Coluna única no mobile */
      }
    }

  </style>
</head>
<body>

  <div class="layout-container">
    <aside class="sidebar">
      <a href="#" class="sidebar-logo">FINANSys</a>
      <nav>
        <ul class="sidebar-nav">
          <li>
            <a href="orcamentoPage.html" class="active">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
              Orçamentos
            </a>
          </li>
          <li>
            <a href="usuarioPage.html">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
              Usuários
            </a>
          </li>
          <li>
            <a href="clientePage.html">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 00-12.728 0M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096V10.5c0 .54-.384 1.006-.917 1.096A48.32 48.32 0 0112 12c-2.755 0-5.455-.232-8.083-.678-.533-.09-.917-.556-.917-1.096V4.774c0-.54.384-1.006.917-1.096A48.317 48.317 0 0112 3z" /></svg>
              Clientes
            </a>
          </li>
        </ul>
      </nav>
    </aside>

    <main class="main-content">
      <header class="main-header">
        <h1 class="main-title">Orçamentos</h1>
        <button id="btnNovoOrcamento" type="button" class="btn btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" /></svg>
          Novo Orçamento
        </button>
      </header>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Cliente</th>
              <th>Usuário (Criador)</th>
              <th>Valor Orçamento</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="orcamentoTableBody">
            </tbody>
        </table>
      </div>
    </main>
  </div>

  <div class="modal-backdrop" id="orcamentoModalBackdrop">
    <div class="modal">
      <form id="orcamentoForm" onsubmit="return false;">
        
        <header class="modal-header">
          <div>
            <h2 class="modal-title">Novo Orçamento</h2>
            <span class="modal-step-indicator" id="modalStepIndicator">Passo 1 de 3</span>
          </div>
          <button type="button" class="modal-close-btn" id="btnCloseModal">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </header>
        
        <div class="modal-body">
          <div class="modal-step active" id="step1">
            <h3 style="margin-bottom: 1rem;">1. Selecione o Cliente</h3>
            <div class="form-group">
              <label for="clienteSearchTerm">Pesquisar Cliente (Nome ou CPF)</label>
              <input type="text" id="clienteSearchTerm" placeholder="Digite para pesquisar...">
              <div id="clienteSearchResults" class="search-results-modal"></div>
              <div id="selectedClienteInfo" class="selected-item-info" style="display: none;"></div>
            </div>
          </div>
          
          <div class="modal-step" id="step2">
            <h3 style="margin-bottom: 1rem;">2. Selecione o Usuário (Criador)</h3>
            <div class="form-group">
              <label for="usuarioSearchTerm">Pesquisar Usuário (Nome)</label>
              <input type="text" id="usuarioSearchTerm" placeholder="Digite para pesquisar...">
              <div id="usuarioSearchResults" class="search-results-modal"></div>
              <div id="selectedUsuarioInfo" class="selected-item-info" style="display: none;"></div>
            </div>
          </div>
          
          <div class="modal-step" id="step3">
            <h3 style="margin-bottom: 1.5rem;">3. Detalhes Finais</h3>
            
            <div class="summary-grid">
              <div class="summary-box">
                <label>Cliente Selecionado</label>
                <p id="summaryCliente">Nenhum</p>
              </div>
              <div class="summary-box">
                <label>Usuário Criador</label>
                <p id="summaryUsuario">Nenhum</p>
              </div>
            </div>

            <div class="form-group">
              <label for="icmsEstados">Dados Fiscais</label>
              <select id="icmsEstados" required>
                <option value="ICMS_MG">Minas Gerais (MG)</option>
                <option value="ICMS_SP">São Paulo (SP)</option>
                <option value="ICMS_RJ">Rio de Janeiro (RJ)</option>
              </select>
            </div>
            <div class="form-group">
              <label for="valorOrcamento">Valor</label>
              <input type="number" id="valorOrcamento" step="0.01" placeholder="R$ 0,00" required>
            </div>
          </div>
        </div>
        
        <footer class="modal-footer">
          <button type="button" class="btn btn-secondary" id="btnVoltar" style="display: none;">Voltar</button>
          <button type="button" class="btn btn-primary" id="btnAvancar">Avançar</button>
          <button type="submit" class="btn btn-primary" id="btnSalvar" style="display: none;">Salvar Orçamento</button>
        </footer>

      </form>
    </div>
  </div>


  <script>
    // URLs da API
    const API_ORCAMENTOS_URL = '/orcamentos/api';
    const API_USUARIOS_URL = '/api/usuarios';
    const API_CLIENTES_URL = '/api/clientes';
    
    // --- Elementos Globais ---
    const orcamentoTableBody = document.getElementById('orcamentoTableBody');
    const orcamentoForm = document.getElementById('orcamentoForm');
    
    // --- Elementos do Modal Wizard ---
    const modalBackdrop = document.getElementById('orcamentoModalBackdrop');
    const btnNovoOrcamento = document.getElementById('btnNovoOrcamento');
    const btnCloseModal = document.getElementById('btnCloseModal');
    
    const modalStepIndicator = document.getElementById('modalStepIndicator');
    const modalSteps = [
      document.getElementById('step1'), 
      document.getElementById('step2'), 
      document.getElementById('step3')
    ];
    
    const btnVoltar = document.getElementById('btnVoltar');
    const btnAvancar = document.getElementById('btnAvancar');
    const btnSalvar = document.getElementById('btnSalvar');

    // --- Elementos de Pesquisa ---
    const clienteSearchInput = document.getElementById('clienteSearchTerm');
    const clienteSearchResults = document.getElementById('clienteSearchResults');
    const selectedClienteInfo = document.getElementById('selectedClienteInfo');
    
    const usuarioSearchInput = document.getElementById('usuarioSearchTerm');
    const usuarioSearchResults = document.getElementById('usuarioSearchResults');
    const selectedUsuarioInfo = document.getElementById('selectedUsuarioInfo');

    // --- Estado do Wizard ---
    let currentStep = 0;
    const wizardState = {
      cliente: null, // { id, nome }
      usuario: null, // { id, nomeUsuario }
    };

    // --- Funções do Modal e Wizard ---

    const goToStep = (stepIndex) => {
      // Esconde todas as etapas
      modalSteps.forEach(step => step.classList.remove('active'));
      
      // Mostra a etapa atual
      modalSteps[stepIndex].classList.add('active');
      currentStep = stepIndex;
      
      modalStepIndicator.textContent = `Passo ${stepIndex + 1} de 3`;

      // Atualiza visibilidade dos botões
      btnVoltar.style.display = (stepIndex > 0) ? 'inline-flex' : 'none';
      btnAvancar.style.display = (stepIndex < modalSteps.length - 1) ? 'inline-flex' : 'none';
      btnSalvar.style.display = (stepIndex === modalSteps.length - 1) ? 'inline-flex' : 'none';
      
      // Atualiza o resumo no passo 3
      if (stepIndex === 2) {
        document.getElementById('summaryCliente').textContent = wizardState.cliente?.nome || 'N/A';
        document.getElementById('summaryUsuario').textContent = wizardState.usuario?.nomeUsuario || 'N/A';
      }
    };

    const openModal = () => {
      document.body.style.overflow = 'hidden';
      // Reseta o estado
      wizardState.cliente = null;
      wizardState.usuario = null;
      clearForm();
      
      selectedClienteInfo.style.display = 'none';
      selectedUsuarioInfo.style.display = 'none';

      goToStep(0); // Começa na primeira etapa
      modalBackdrop.classList.add('active');
    };

    const closeModal = () => {
      document.body.style.overflow = 'auto';
      modalBackdrop.classList.remove('active');
      clearForm();
    };

    const clearForm = () => {
      orcamentoForm.reset();
      clienteSearchInput.value = '';
      clienteSearchResults.innerHTML = '';
      usuarioSearchInput.value = '';
      usuarioSearchResults.innerHTML = '';
    };

    // Navegação do Wizard
    btnAvancar.addEventListener('click', () => {
      // Validação antes de avançar
      if (currentStep === 0 && !wizardState.cliente) {
        alert('Por favor, selecione um cliente para continuar.');
        return;
      }
      if (currentStep === 1 && !wizardState.usuario) {
        alert('Por favor, selecione um usuário para continuar.');
        return;
      }
      goToStep(currentStep + 1);
    });

    btnVoltar.addEventListener('click', () => {
      if (currentStep > 0) {
        goToStep(currentStep - 1);
      }
    });

    // --- Funções de Pesquisa (Refatoradas para o Wizard) ---

    // Pesquisa de Cliente
    clienteSearchInput.addEventListener('input', async () => {
      const searchTerm = clienteSearchInput.value;
      if (searchTerm.length < 2) {
        clienteSearchResults.innerHTML = '';
        return;
      }
      try {
        const response = await fetch(`${API_CLIENTES_URL}/pesquisa?termo=${encodeURIComponent(searchTerm)}`);
        const clientes = await response.json();
        clienteSearchResults.innerHTML = '';
        if (clientes.length > 0) {
          clientes.forEach(cli => {
            const item = `<div class="result-item" data-id="${cli.id}" data-nome="${cli.nome}">${cli.nome} (CPF: ${cli.cpf})</div>`;
            clienteSearchResults.insertAdjacentHTML('beforeend', item);
          });
        } else {
          clienteSearchResults.innerHTML = '<div style="padding: 0.75rem 1rem;">Nenhum cliente encontrado.</div>';
        }
      } catch (error) {
        console.error('Erro ao pesquisar cliente:', error);
      }
    });

    // Seleção de Cliente
    clienteSearchResults.addEventListener('click', (e) => {
      if (e.target.classList.contains('result-item')) {
        const { id, nome } = e.target.dataset;
        wizardState.cliente = { id: parseInt(id), nome: nome };
        
        selectedClienteInfo.innerHTML = `<strong>Selecionado:</strong> ${nome}`;
        selectedClienteInfo.style.display = 'block';
        clienteSearchResults.innerHTML = ''; // Limpa resultados
        clienteSearchInput.value = nome; // Opcional: preenche o input
      }
    });
    
    // Pesquisa de Usuário
    usuarioSearchInput.addEventListener('input', async () => {
      const searchTerm = usuarioSearchInput.value;
      if (searchTerm.length < 2) {
        usuarioSearchResults.innerHTML = '';
        return;
      }
      try {
        const response = await fetch(`${API_USUARIOS_URL}/pesquisa?nome=${encodeURIComponent(searchTerm)}`);
        const usuarios = await response.json();
        usuarioSearchResults.innerHTML = '';
        if (usuarios.length > 0) {
          usuarios.forEach(user => {
            const item = `<div class="result-item" data-id="${user.id}" data-nome="${user.nomeUsuario}">${user.nomeUsuario} (CPF: ${user.cpf})</div>`;
            usuarioSearchResults.insertAdjacentHTML('beforeend', item);
          });
        } else {
          usuarioSearchResults.innerHTML = '<div style="padding: 0.75rem 1rem;">Nenhum usuário encontrado.</div>';
        }
      } catch (error) {
        console.error('Erro ao pesquisar usuário:', error);
      }
    });

    // Seleção de Usuário
    usuarioSearchResults.addEventListener('click', (e) => {
      if (e.target.classList.contains('result-item')) {
        const id = e.target.dataset.id;
        const nome = e.target.dataset.nome;
        wizardState.usuario = { id: parseInt(id), nomeUsuario: nome };
        
        selectedUsuarioInfo.innerHTML = `<strong>Selecionado:</strong> ${nome}`;
        selectedUsuarioInfo.style.display = 'block';
        usuarioSearchResults.innerHTML = '';
        usuarioSearchInput.value = nome;
      }
    });


    // --- Funções de API (CRUD) ---

    const fetchAndRenderOrcamentos = async () => {
      try {
        const response = await fetch(API_ORCAMENTOS_URL);
        const orcamentos = await response.json();
        orcamentoTableBody.innerHTML = '';
        
        if (orcamentos.length === 0) {
          orcamentoTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">Nenhum orçamento cadastrado.</td></tr>';
          return;
        }

        const formatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

        orcamentos.forEach(orc => {
          const row = `
            <tr>
              <td>#${orc.id}</td>
              <td>${orc.cliente ? orc.cliente.nome : 'N/A'}</td>
              <td>${orc.usuario ? orc.usuario.nomeUsuario : 'N/A'}</td>
              <td class="valor-cell">${formatter.format(orc.valorOrcamento)}</td>
              <td class="table-actions">
                <button class="btn btn-icon btn-danger" onclick="deleteOrcamento(${orc.id})">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.56 0c.342.052.682.107 1.022.166m11.538 0l-2.094-1.995c-.372-.353-.83-.599-1.33-.708L10.5 2.25H13.5c.502 0 .96.246 1.33.708l2.094 1.995z" /></svg>
                </button>
              </td>
            </tr>
          `;
          orcamentoTableBody.insertAdjacentHTML('beforeend', row);
        });
      } catch (error) {
        console.error('Erro ao carregar orçamentos:', error);
      }
    };

    // Salvar Orçamento (Handler do Submit)
    orcamentoForm.addEventListener('submit', async () => {
      // Validação final
      if (!wizardState.cliente || !wizardState.usuario) {
        alert("Erro: Cliente ou Usuário não estão definidos.");
        goToStep(0); // Volta ao início
        return;
      }
      
      const orcamentoData = {
        icmsEstados: document.getElementById('icmsEstados').value,
        valorOrcamento: parseFloat(document.getElementById('valorOrcamento').value),
        usuario: {
          id: wizardState.usuario.id
        },
        cliente: {
          id: wizardState.cliente.id
        }
      };

      try {
        const response = await fetch(API_ORCAMENTOS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(orcamentoData),
        });
        if (!response.ok) {
           const errorText = await response.text();
           throw new Error(`Falha ao salvar o orçamento: ${errorText}`);
        }
        
        closeModal();
        fetchAndRenderOrcamentos();
        alert('Orçamento cadastrado com sucesso!');
        
      } catch (error) {
        console.error('Erro ao salvar orçamento:', error);
        alert('Ocorreu um erro: ' + error.message);
      }
    });

    // Deletar Orçamento
    const deleteOrcamento = async (orcamentoId) => {
      if (confirm(`Tem certeza que deseja excluir o orçamento ID ${orcamentoId}?`)) {
        try {
          await fetch(`${API_ORCAMENTOS_URL}/${orcamentoId}`, { method: 'DELETE' });
          fetchAndRenderOrcamentos();
        } catch (error) {
          console.error('Erro ao excluir:', error);
        }
      }
    };

    // --- Listeners de Eventos ---
    btnNovoOrcamento.addEventListener('click', openModal);
    btnCloseModal.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) {
        closeModal();
      }
    });

    // Carregamento inicial
    document.addEventListener('DOMContentLoaded', fetchAndRenderOrcamentos);
  </script>

</body>
</html>